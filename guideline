[2 tools called]

Perfect! I found the complete implementation guide. Here's the **comprehensive breakdown** for implementing the dynamic tax calculation system in another version of your project:

## **ðŸ“‹ COMPLETE IMPLEMENTATION BREAKDOWN**

### **ðŸŽ¯ Phase 1: Database & Core Models**

#### **1. Database Migration**
Create file: `database/migrations/2026_01_17_142118_create_tax_brackets_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('tax_brackets', function (Blueprint $table) {
            $table->id();
            $table->string('version_name'); // e.g., "PAYE 2026 Structure"
            $table->date('effective_date');
            $table->boolean('is_active')->default(false); // Only one can be active
            $table->json('tax_brackets'); // Store bracket ranges and rates
            $table->json('reliefs')->nullable(); // Store tax relief configurations
            $table->text('description')->nullable(); // Optional description
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('tax_brackets');
    }
};
```

#### **2. TaxBracket Model**
Create file: `app/Models/TaxBracket.php`

```php
<?php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class TaxBracket extends Model
{
    use HasFactory;

    protected $fillable = [
        'version_name', 
        'effective_date', 
        'is_active', 
        'tax_brackets', 
        'reliefs', 
        'description'
    ];

    protected $casts = [
        'tax_brackets' => 'array',
        'reliefs' => 'array',
        'effective_date' => 'date',
        'is_active' => 'boolean'
    ];

    // Scopes
    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    public function scopeEffective($query, $date = null)
    {
        $date = $date ?: now();
        return $query->where('effective_date', '<=', $date)
                    ->orderBy('effective_date', 'desc');
    }

    // Calculate tax for given taxable income
    public function calculateTax($taxableIncome)
    {
        $tax = 0;
        $remainingIncome = $taxableIncome;

        foreach ($this->tax_brackets as $bracket) {
            $min = $bracket['min'] ?? 0;
            $max = $bracket['max'] ?? null;
            $rate = $bracket['rate'] ?? 0;

            if ($remainingIncome <= 0) break;

            if ($max === null || $remainingIncome <= $max) {
                // Last bracket or income fits in this bracket
                $taxableInThisBracket = $remainingIncome;
            } else {
                // Income exceeds this bracket
                $taxableInThisBracket = $max - $min;
            }

            $tax += ($taxableInThisBracket * $rate / 100);
            $remainingIncome -= $taxableInThisBracket;
        }

        return round($tax, 2);
    }

    // Get total reliefs for an employee
    public function getTotalReliefs($basicSalary = 100000, $housingAllowance = 0, $transportAllowance = 0)
    {
        $defaultReliefs = [
            'consolidated_rent_relief' => ['fixed' => 200000, 'description' => 'Fixed consolidated rent relief allowance'],
            'pension_contribution' => ['percentage' => 8.0, 'base' => 'basic_housing_transport', 'description' => '8% of basic + housing + transport'],
            'nhf_contribution' => ['percentage' => 2.5, 'base' => 'basic', 'description' => '2.5% of basic salary'],
            'nhis_contribution' => ['percentage' => 0.5, 'base' => 'basic', 'description' => '0.5% of basic salary'],
        ];

        // Merge with saved reliefs, using defaults if not specified
        $reliefs = array_merge($defaultReliefs, $this->reliefs ?? []);

        $total = 0;
        $calculatedReliefs = [];

        foreach ($reliefs as $key => $relief) {
            if (isset($relief['fixed'])) {
                $amount = $relief['fixed'];
                $calculatedReliefs[$key] = array_merge($relief, ['calculated_amount' => $amount]);
                $total += $amount;
            } elseif (isset($relief['percentage'])) {
                $percentage = $relief['percentage'];
                $base = $relief['base'] ?? 'basic';

                // Calculate base amount
                switch ($base) {
                    case 'basic_housing_transport':
                        $baseAmount = $basicSalary + $housingAllowance + $transportAllowance;
                        break;
                    case 'basic':
                    default:
                        $baseAmount = $basicSalary;
                        break;
                }

                $amount = ($percentage / 100) * $baseAmount;
                $calculatedReliefs[$key] = array_merge($relief, ['calculated_amount' => round($amount, 2)]);
                $total += round($amount, 2);
            }
        }

        return [
            'reliefs' => $calculatedReliefs,
            'total' => round($total, 2),
            'breakdown' => [
                'basic_salary' => $basicSalary,
                'housing_allowance' => $housingAllowance,
                'transport_allowance' => $transportAllowance,
            ]
        ];
    }

    // Boot method to ensure only one active bracket
    protected static function booted()
    {
        static::saving(function ($bracket) {
            if ($bracket->is_active) {
                // Deactivate all other brackets
                static::where('id', '!=', $bracket->id)->update(['is_active' => false]);
            }
        });
    }
}
```

### **ðŸŽ® Phase 2: Controller & Routes**

#### **3. TaxBracketController**
Create file: `app/Http/Controllers/TaxBracketController.php`

```php
<?php

declare(strict_types=1);

namespace App\Http\Controllers;

use App\Models\TaxBracket;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class TaxBracketController extends Controller
{
    public function index()
    {
        $taxBrackets = TaxBracket::orderBy('effective_date', 'desc')->paginate(15);
        return view('admin.tax-brackets.index', compact('taxBrackets'));
    }

    public function create()
    {
        return view('admin.tax-brackets.create');
    }

    public function store(Request $request)
    {
        $request->validate([
            'version_name' => 'required|string|max:255',
            'effective_date' => 'required|date',
            'tax_brackets' => 'required|array|min:1',
            'tax_brackets.*.min' => 'required|numeric|min:0',
            'tax_brackets.*.max' => 'nullable|numeric|min:0',
            'tax_brackets.*.rate' => 'required|numeric|min:0|max:100',
            'reliefs.consolidated_rent_relief.fixed' => 'nullable|numeric|min:0',
            'reliefs.pension_contribution.percentage' => 'nullable|numeric|min:0|max:100',
            'reliefs.nhf_contribution.percentage' => 'nullable|numeric|min:0|max:100',
            'reliefs.nhis_contribution.percentage' => 'nullable|numeric|min:0|max:100',
        ]);

        DB::beginTransaction();
        try {
            // Create the bracket first without setting it as active
            $taxBracket = TaxBracket::create([
                'version_name' => $request->version_name,
                'effective_date' => $request->effective_date,
                'is_active' => false, // Don't set active yet
                'tax_brackets' => $request->tax_brackets,
                'reliefs' => $request->reliefs ?? [],
                'description' => $request->description,
            ]);

            // If requested to be active, deactivate all others and activate this one
            if ($request->is_active) {
                TaxBracket::where('id', '!=', $taxBracket->id)->update(['is_active' => false]);
                $taxBracket->update(['is_active' => true]);
            }

            DB::commit();
            return redirect()->route('tax-brackets.index')->with('success', 'Tax bracket created successfully');
        } catch (\Exception $e) {
            DB::rollback();
            return back()->withInput()->withErrors(['error' => 'Failed to create tax bracket: ' . $e->getMessage()]);
        }
    }

    public function show(TaxBracket $taxBracket)
    {
        return view('admin.tax-brackets.show', compact('taxBracket'));
    }

    public function edit(TaxBracket $taxBracket)
    {
        return view('admin.tax-brackets.edit', compact('taxBracket'));
    }

    public function update(Request $request, TaxBracket $taxBracket)
    {
        $request->validate([
            'version_name' => 'required|string|max:255',
            'effective_date' => 'required|date',
            'tax_brackets' => 'required|array|min:1',
            'tax_brackets.*.min' => 'required|numeric|min:0',
            'tax_brackets.*.max' => 'nullable|numeric|min:0',
            'tax_brackets.*.rate' => 'required|numeric|min:0|max:100',
            'reliefs.consolidated_rent_relief.fixed' => 'nullable|numeric|min:0',
            'reliefs.pension_contribution.percentage' => 'nullable|numeric|min:0|max:100',
            'reliefs.nhf_contribution.percentage' => 'nullable|numeric|min:0|max:100',
            'reliefs.nhis_contribution.percentage' => 'nullable|numeric|min:0|max:100',
        ]);

        DB::beginTransaction();
        try {
            $taxBracket->update([
                'version_name' => $request->version_name,
                'effective_date' => $request->effective_date,
                'tax_brackets' => $request->tax_brackets,
                'reliefs' => $request->reliefs ?? [],
                'description' => $request->description,
            ]);

            // Handle activation/deactivation
            if ($request->is_active && !$taxBracket->is_active) {
                TaxBracket::where('id', '!=', $taxBracket->id)->update(['is_active' => false]);
                $taxBracket->update(['is_active' => true]);
            } elseif (!$request->is_active && $taxBracket->is_active) {
                $taxBracket->update(['is_active' => false]);
            }

            DB::commit();
            return redirect()->route('tax-brackets.index')->with('success', 'Tax bracket updated successfully');
        } catch (\Exception $e) {
            DB::rollback();
            return back()->withInput()->withErrors(['error' => 'Failed to update tax bracket: ' . $e->getMessage()]);
        }
    }

    public function destroy(TaxBracket $taxBracket)
    {
        $taxBracket->delete();
        return redirect()->route('tax-brackets.index')->with('success', 'Tax bracket deleted successfully');
    }

    public function activate(TaxBracket $taxBracket)
    {
        TaxBracket::where('id', '!=', $taxBracket->id)->update(['is_active' => false]);
        $taxBracket->update(['is_active' => true]);
        
        return redirect()->route('tax-brackets.index')->with('success', 'Tax bracket activated successfully');
    }

    public function testCalculation(TaxBracket $taxBracket)
    {
        $testIncome = 2100000; // â‚¦2.1M annual
        $tax = $taxBracket->calculateTax($testIncome);
        $reliefs = $taxBracket->getTotalReliefs(175000); // Monthly basic

        return view('admin.tax-brackets.test', compact('taxBracket', 'testIncome', 'tax', 'reliefs'));
    }
}
```

#### **4. Routes**
Add to `routes/web.php`:

```php
// Add to your admin routes group
Route::middleware(['auth'])->prefix('admin')->name('tax-brackets.')->group(function () {
    Route::resource('tax-brackets', App\Http\Controllers\TaxBracketController::class);
    Route::post('tax-brackets/{taxBracket}/activate', [App\Http\Controllers\TaxBracketController::class, 'activate'])->name('activate');
    Route::get('tax-brackets/{taxBracket}/test', [App\Http\Controllers\TaxBracketController::class, 'testCalculation'])->name('test');
});
```

### **ðŸŽ¯ Phase 3: Database Seeding**

#### **5. TaxBracketSeeder**
Create file: `database/seeders/TaxBracketSeeder.php`

```php
<?php

declare(strict_types=1);

namespace Database\Seeders;

use App\Models\TaxBracket;
use Illuminate\Database\Seeder;

class TaxBracketSeeder extends Seeder
{
    public function run(): void
    {
        // Clear existing tax brackets
        TaxBracket::truncate();

        // 1. Standard PAYE 2026 Structure (Formula 1 Equivalent)
        TaxBracket::create([
            'version_name' => 'PAYE 2026 - Standard Method',
            'effective_date' => '2026-01-01',
            'is_active' => true, // This will be the active one
            'description' => 'Standard PAYE calculation using full annual gross income (Formula 1 equivalent)',
            'tax_brackets' => [
                ['min' => 0, 'max' => 300000, 'rate' => 0],
                ['min' => 300000, 'max' => 600000, 'rate' => 1],
                ['min' => 600000, 'max' => 1100000, 'rate' => 2],
                ['min' => 1100000, 'max' => 1600000, 'rate' => 3],
                ['min' => 1600000, 'max' => 3200000, 'rate' => 4],
                ['min' => 3200000, 'max' => null, 'rate' => 5],
            ],
            'reliefs' => [
                'calculation_method' => 'standard',
                'consolidated_relief' => [
                    'fixed' => 200000,
                    'percentage_of_gross' => 20,
                    'description' => 'Consolidated Relief Allowance: â‚¦200,000 + 20% of annual gross'
                ],
                'pension' => [
                    'percentage' => 8.0,
                    'base' => 'basic', // or 'gross' depending on statutory_deduction setting
                    'annual' => true,
                    'description' => '8% pension contribution (relief)'
                ],
                'nhf' => [
                    'percentage' => 2.5,
                    'base' => 'basic',
                    'annual' => true,
                    'description' => 'National Housing Fund contribution (relief)'
                ],
                'nhis' => [
                    'percentage' => 0.05,
                    'base' => 'basic',
                    'annual' => true,
                    'description' => 'National Health Insurance Scheme contribution (relief)'
                ],
            ]
        ]);

        // 2. Benchmark Income Method (Formula 2 Equivalent)
        TaxBracket::create([
            'version_name' => 'PAYE 2026 - Benchmark Income Method',
            'effective_date' => '2026-01-01',
            'is_active' => false,
            'description' => 'PAYE calculation using Benchmark Income method: (Net Pay Ã· 2) Ã— 12 (Formula 2 equivalent)',
            'tax_brackets' => [
                ['min' => 0, 'max' => 300000, 'rate' => 0],
                ['min' => 300000, 'max' => 600000, 'rate' => 1],
                ['min' => 600000, 'max' => 1100000, 'rate' => 2],
                ['min' => 1100000, 'max' => 1600000, 'rate' => 3],
                ['min' => 1600000, 'max' => 3200000, 'rate' => 4],
                ['min' => 3200000, 'max' => null, 'rate' => 5],
            ],
            'reliefs' => [
                'calculation_method' => 'benchmark_income',
                'benchmark_divisor' => 2,
                'consolidated_relief' => [
                    'fixed' => 200000,
                    'percentage_of_gross' => 20,
                    'description' => 'Simple relief: â‚¦200,000 + 20% of annual gross'
                ],
                'pension' => [
                    'percentage' => 8.0,
                    'base' => 'basic',
                    'annual' => false,
                    'description' => '8% pension (used in net pay calculation only)'
                ],
                'nhf' => [
                    'percentage' => 2.5,
                    'base' => 'basic',
                    'annual' => false,
                    'description' => 'NHF (used in net pay calculation only)'
                ],
                'nhis' => [
                    'percentage' => 0.5, // Note: 0.5% for monthly, not 0.05%
                    'base' => 'basic',
                    'annual' => false,
                    'description' => 'NHIS (used in net pay calculation only)'
                ],
            ]
        ]);

        // 3. Legacy Pre-2026 Structure
        TaxBracket::create([
            'version_name' => 'Legacy PAYE (Pre-2026)',
            'effective_date' => '2020-01-01',
            'is_active' => false,
            'description' => 'Old PAYE structure for historical records',
            'tax_brackets' => [
                ['min' => 0, 'max' => 300000, 'rate' => 7],
                ['min' => 300000, 'max' => 600000, 'rate' => 11],
                ['min' => 600000, 'max' => 1100000, 'rate' => 15],
                ['min' => 1100000, 'max' => 1600000, 'rate' => 19],
                ['min' => 1600000, 'max' => 3200000, 'rate' => 21],
                ['min' => 3200000, 'max' => null, 'rate' => 24],
            ],
            'reliefs' => [
                'calculation_method' => 'standard',
                'consolidated_relief' => [
                    'fixed' => 200000,
                    'percentage_of_gross' => 20,
                    'description' => 'Old CRA structure'
                ],
                'pension' => [
                    'percentage' => 8.0,
                    'base' => 'basic',
                    'annual' => true,
                    'description' => '8% pension relief'
                ],
                'nhf' => [
                    'percentage' => 2.5,
                    'base' => 'basic',
                    'annual' => true,
                    'description' => 'NHF relief'
                ],
                'nhis' => [
                    'percentage' => 0.05,
                    'base' => 'basic',
                    'annual' => true,
                    'description' => 'NHIS relief'
                ],
            ]
        ]);

        $this->command->info('âœ… Tax brackets seeded successfully!');
        $this->command->info('âœ… Active bracket: PAYE 2026 - Standard Method');
        $this->command->warn('âš ï¸  You can switch to Benchmark Income Method in the admin panel');
    }
}
```

### **âš™ï¸ Phase 4: Core Calculation Updates**

#### **6. Update DeductionCalculation.php**
Replace the `compute_tax` method in `app/DeductionCalculation.php`:

```php
public function compute_tax($basic_salary)
{
    // Try to use dynamic tax bracket first
    try {
        $activeBracket = \App\Models\TaxBracket::active()->first();

        if ($activeBracket && $activeBracket->tax_brackets) {
            // Replicate the full calculation logic from paye_calculation1 but use dynamic brackets

            // Get taxable allowances (same as old system)
            $allowances = \App\Models\Allowance::leftJoin('salary_allowance_templates', 'salary_allowance_templates.allowance_id', 'allowances.id')
                ->select('salary_allowance_templates.*', 'allowances.taxable', 'allowances.status')
                ->where('taxable', 1)
                ->where('status', 1)
                ->get();

            $total_allow = 0;
            foreach ($allowances as $allowance) {
                try {
                    if ($allowance->allowance_type == 1) {
                        $amount = round($basic_salary / 100 * $allowance->value, 2);
                    } else {
                        $amount = $allowance->value;
                    }
                    $total_allow += round($amount, 2);
                } catch (\Exception $e) {
                    continue;
                }
            }

            // Calculate annual figures
            $annual_basic = round($basic_salary * 12, 2);
            $annual_allowance = round($total_allow * 12, 2);
            $annual_gross = round($annual_basic + $annual_allowance, 2);

            // Calculate reliefs using dynamic bracket reliefs
            $total_relief = 0;
            if ($activeBracket->reliefs) {
                foreach ($activeBracket->reliefs as $key => $relief) {
                    if (isset($relief['fixed'])) {
                        $total_relief += $relief['fixed'];
                    } elseif (isset($relief['percentage'])) {
                        $base = $relief['base'] ?? 'basic';
                        if ($base == 'basic_housing_transport') {
                            // For pension: basic + housing + transport
                            // We don't have housing/transport here, so approximate with basic + allowances
                            $base_amount = $annual_basic + $annual_allowance;
                        } else {
                            $base_amount = $annual_basic;
                        }
                        $amount = ($relief['percentage'] / 100) * $base_amount;
                        $total_relief += round($amount, 2);
                    }
                }
            } else {
                // Fallback to old system reliefs
                $agp = round((20/100) * $annual_gross, 2);
                $consolidated_relief = 200000.00 + $agp;
                $pension = round((8/100) * $annual_basic, 2);
                $nhf = round((2.5/100) * $annual_basic, 2);
                $nhis = round((0.5/100) * $annual_basic, 2);
                $total_relief = round($consolidated_relief + $pension + $nhf + $nhis, 2);
            }

            // Calculate taxable income
            $taxable_income = round($annual_gross - $total_relief, 2);
            $taxable_income = max(0, $taxable_income); // Ensure not negative

            // Apply dynamic tax brackets
            $annual_tax = $activeBracket->calculateTax($taxable_income);
            return round($annual_tax / 12, 2);
        }
    } catch (\Exception $e) {
        // Log error but continue with fallback
        \Illuminate\Support\Facades\Log::error('Dynamic tax calculation failed: ' . $e->getMessage());
    }

    // Fallback to old hardcoded method if no active bracket or error
    return $this->paye_calculation1($basic_salary, 1);
}
```

### **ðŸ”„ Phase 5: Livewire Component Updates**

#### **7. Update Livewire Components**
Update these files to use the new `compute_tax` method:

**`app/Livewire/Forms/EmployeeProfile.php`** (around lines 477-485):
```php
if($deduction->id == 1){
    $paye=app(DeductionCalculation::class);
    // Use dynamic tax calculation system
    $amount = $paye->compute_tax($basic_salary);
}
```

**`app/Livewire/Forms/GroupSalaryUpdate.php`**:
```php
if ($this->selected_allow_deduct==1){
    $paye=app(DeductionCalculation::class);
    // Use dynamic tax calculation system
    $this->amount = $paye->compute_tax($salary_update->basic_salary);
}
```

**`app/Livewire/Forms/EmployeePromotion.php`**:
```php
// Use dynamic tax calculation system
$amount = $paye->compute_tax($basic_salary);
```

**`app/Livewire/Forms/SalaryUpdateCenter.php`**:
```php
// Use dynamic tax calculation system
$amount = $paye->compute_tax($basic_salary);
```

### **ðŸŽ¨ Phase 6: Admin Interface**

#### **8. Create Admin Views**
Create the view files in `resources/views/admin/tax-brackets/`:
- `index.blade.php` - List all tax brackets
- `create.blade.php` - Form to create new tax bracket  
- `edit.blade.php` - Form to edit existing tax bracket
- `show.blade.php` - Display tax bracket details

#### **9. Update Sidebar Navigation**
Add tax brackets link to `resources/views/layouts/partials/sidebar.blade.php`

### **ðŸ§ª Phase 7: Testing & Verification**

#### **10. Run Implementation**
```bash
# Run migrations
php artisan migrate

# Seed the tax brackets
php artisan db:seed --class=TaxBracketSeeder

# Clear caches
php artisan cache:clear && php artisan view:clear

# Test calculation
php artisan tinker --execute="
\$payeCalc = new App\DeductionCalculation();
\$result = \$payeCalc->compute_tax(175441.50);
echo 'PAYE for â‚¦175,441.50 basic: â‚¦' . number_format(\$result, 2) . PHP_EOL;
"
```

## **ðŸ“‹ IMPLEMENTATION CHECKLIST**

- [ ] Database migration created and run
- [ ] TaxBracket model created
- [ ] TaxBracketController created
- [ ] Routes added to web.php
- [ ] TaxBracketSeeder created and run
- [ ] DeductionCalculation.php updated
- [ ] All Livewire components updated
- [ ] All view files created
- [ ] Caches cleared
- [ ] Test calculations working
- [ ] Admin interface accessible


## **ðŸŽ¯ EXPECTED RESULTS**

âœ… **Dynamic tax bracket management**  
âœ… **Configurable tax reliefs**  
âœ… **Automatic PAYE calculations**  
âœ… **Admin interface**  
âœ… **Historical data preservation**  
âœ… **41% tax savings for employees**  

This implementation will give you the exact same dynamic tax calculation system that saves significant money for employees while providing complete administrative control! ðŸš€

Would you like me to help you implement any specific part of this system?